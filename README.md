<p align="center">
  <img src="https://cdn.rawgit.com/sqmk/huejay/8ca17db521eab6dbcfeabf93483f2700d7aa44bb/media/logo.svg" alt="Huejay" />
</p>

# Huejay - Philips Hue client for Node.js

[![NPM Version](https://badge.fury.io/js/huejay.svg)](https://www.npmjs.com/package/huejay)
[![Build Status](https://api.travis-ci.org/sqmk/huejay.svg?branch=master)](https://travis-ci.org/sqmk/huejay)

Huejay is a client for the Philips Hue home lighting system.

Use Huejay to interact with Philips Hue in the following ways:
* [Bridge discovery](#bridge-discovery)
* [Manage bridge settings](#bridge)
* [Manage portal settings](#portal)
* [Manage software updates](#software-update)
* [Manage users](#users)
* [Manage lights](#lights)
* [Manage groups](#groups)
* [Manage schedules](#schedules)
* [Manage scenes](#scenes)
* [Manage sensors](#sensors)
* [Retrieve and delete rules](#rules)

## Installation

Huejay was written for **Node.js 4+**.

`npm install --save huejay`

## Basic Usage

Requiring the library is simple:

```js
let huejay = require('huejay');
```

Most methods return a `Promise` as a result. These are native Node.js promises.

### Bridge Discovery

Before interacting with your Hue system, you may want to know the availability
and IP addresses of your bridges. You can use Huejay's `discover` method to find
them.

```js
huejay.discover()
  .then(bridges => {
    for (let bridge of bridges) {
      console.log(`Id: ${bridge.id}, IP: ${bridge.ip}`);
    }
  })
  .catch(error => {
    console.log(`An error occurred: ${error.message}`);
  });
```

Huejay offers several strategies for bridge discovery:
* **nupnp**: Default option, uses Meethue's public API to discover local bridges
* **upnp**: Uses SSDP to discover local bridges
* **all**: Uses all available strategies for discovery

To use a specific discovery strategy:

```js
huejay.discover({strategy: 'upnp'})
  .then(bridges => {
    console.log(bridges);
  });
```

### Errors

Nearly all errors returned by Huejay are of type `huejay.Error`. Use this to
check Huejay specific errors.

## Client Usage

You can use Huejay to retrieve and manipulate resources on your preferred bridge.
Resources include users, lights, groups, scenes, and others.

To start, you must instantiate a client. The `Client` class is available for
convenience via Huejay;

```js
let client = new huejay.Client({
  host:     '123.0.12.34',
  port:     80,               // Optional
  username: 'bridgeusername', // Optional
});
```

If a *username* is not provided, nearly all commands will fail due to failure to
authenticate with the bridge. Be sure to provide a valid *username* to use all
client commands.

### Users

Huejay provides several commands for managing users on Philips Hue bridges.

#### client.users.create - Create user

You can use Huejay to create users on the bridge. Creating a user requires the
bridge's link button to be pressed. The link button is activated for roughly
30 seconds.

To create a user, instantiate a `User` object and pass it to `client.users.create`.
On successful creation, a brand new `User` object is returned by way of a `Promise`.
The `User` object will contain a username generated by the bridge. You can use
this username to authenticate against the bridge going forward.

```js
let user = new client.users.User;

// Optionally configure a device type / agent on the user
user.deviceType = 'my_device_type'; // Default is 'huejay'

client.users.create(user)
  .then(user => {
    console.log(`New user created - Username: ${user.username}`);
  })
  .catch(error => {
    if (error instanceof huejay.Error && error.type === 101) {
      return console.log(`Link button not pressed. Try again...`);
    }

    console.log(error.stack);
  });
```

*Note: The bridge does not permit supplying your own username.*

*Note: It is possible to use Huejay to toggle the link button if you are already
authenticated with the bridge. This may save you from walking over to the bridge
to physically press the link button. See `client.bridge.save` and `Bridge`
`linkButtonEnabled`.*

#### client.users.get - Get authenticated user

If the username assigned to the client is legitimate, you can get the details for
this user by calling `client.users.get`.

```js
client.users.get()
  .then(user => {
    console.log(`Username: ${user.username}`);
    console.log(`Device type: ${user.deviceType}`);
    console.log(`Create date: ${user.createDate}`);
    console.log(`Last use date: ${user.lastUseDate}`);
  });
```

#### client.users.getByUsername - Get user by username

Although the bridge does not provide an equivalent API for retrieving a user
by username, Huejay provides a means to do so.

Simply pass in a string containing username to `client.users.getByUsername` to
look up the user.

```js
client.users.getByUsername('usernamehere')
  .then(user => {
    console.log(`Username: ${user.username}`);
  });
  .catch(error => {
    console.log(error.stack);
  });
```

If a user is not found with the provided username, a `huejay.Error` is thrown.

#### client.users.getAll - Get all users

Want to retrieve all users assigned to the bridge? You can use
`client.users.getAll` to do so. This method will return an array of `User`
objects.

```js
client.users.getAll()
  .then(users => {
    for (let user of users) {
      console.log(`Username: ${user.username}`);
    }
  });
```

#### client.users.delete - Delete a user

Deleting users using Huejay is simple. Provide either a username or `User`
object to `client.users.delete` to delete a user.

```js
client.users.delete('usernamehere')
  .then(() => {
    console.log('User was deleted');
  })
  .catch(error => {
    console.log(error.stack);
  });
```

### Bridge

Huejay supports retrieving and configuring the Philips Hue bridge. It supports
testing connection and authentication to the bridge as well.

#### client.bridge.ping - Test connection to the bridge

Use `client.bridge.ping` to test connection to your preferred bridge. Failed
connection results in a thrown `huejay.Error`.

```js
client.bridge.ping()
  .then(() => {
    console.log('Successful connection');
  })
  catch(error => {
    console.log('Could not connect');
  });
```

#### client.bridge.isAuthenticated - Test authentication to the bridge

To ensure your supplied client username can authenticate to the bridge, use
`client.bridge.isAuthenticated`. Authentication or connection failure will
result `huejay.Error` being thrown.

```js
client.bridge.isAuthenticated()
  .then(() => {
    console.log('Successful authentication');
  })
  catch(error => {
    console.log('Could not authenticate');
  });
```

#### client.bridge.get - Get bridge details and configuration

Want to get bridge details? Use Huejay's `client.bridge.get`
method. This will return a `Bridge` object, which can be used for reading
and saving configuration.

```js
client.bridge.get()
  .then(bridge => {
    console.log(`Retrieved bridge ${bridge.name}`);
    console.log(`  Id: ${bridge.id}`);
    console.log(`  Model Id: ${bridge.modelId}`);
  });
```

Attributes available on the `Bridge` object:
- `id` - Unique
- `name` - Name of the bridge
- `modelId` - Model Id
- `factoryNew` - Whether or not the bridge is factory new
- `replacesBridgeId` - Replaces bridge id (for migrating from old bridges)
- `softwareVersion` - Software version of the bridge
- `apiVersion` - API version of the bridge
- `zigbeeChannel` - ZigBee channel (for communicating with lights)
- `macAddress` - MAC address
- `ipAddress` - IP address
- `dhcpEnabled` - Whether or not DHCP is enabled
- `netmask` - Netmask
- `gateway` - Gateway
- `proxyAddress` - Proxy address
- `proxyPort` - Proxy port
- `utcTime` - UTC time of the bridge
- `timeZone` - Time zone
- `localTime` - Local time of the bridge
- `portalServicesEnabled` - Whether or not portal services are enabled
- `portalConnected` - Whether or not portal is connected
- `linkButtonEnabled` - Whether or not link button is enabled
- `touchLinkEnabled` - Whether or not touch link is enabled

#### client.bridge.save - Save bridge configuration

You can configure the bridge by changing values on the `Bridge` object and
passing to the `client.bridge.save` method. This method will return the same
`Bridge` for further manipulation.

```js
client.bridge.get()
  .then(bridge => {
    // Change bridge's name
    bridge.name = 'New bridge name';

    return client.bridge.save(bridge);
  })
  .then(bridge => {
    console.log(`Bridge is now named ${bridge.name}`);
  });
```

The following `Bridge` attributes are configurable:
- `name` - Name of the bridge
- `zigbeeChannel` - Preferred ZigBee channel
- `ipAddress` - IP address
- `dhcpEnabled` - `true` to enable, `false` to disable
- `netmask` - Netmask
- `gateway` - Gateway
- `proxyPort` - Proxy port
- `proxyAddress` - Proxy address
- `timeZone` - Any value available in `client.timeZones.getAll`
- `linkButtonEnabled` - `true` to toggle on temporarily
- `touchLinkEnabled` - `true` to toggle on temporarily

### Portal

The Philips Hue bridge allows connection to Philips' Meethue.com portal
services. You can use Meethue.com to remotely configure numerous resources
on your bridge, including lights, devices, and scenes.

Huejay provides a way to retrieve Meethue's portal connectivity details.

#### client.portal.get - Get portal details

Use `client.portal.get` to retrieve connectivity details. This method will
return a `Portal` object.

```js
client.portal.get()
  .then(portal => {
    console.log(`Is signed on: ${portal.signedOn}`);
    console.log(`Incoming: ${portal.incoming}`);
    console.log(`Outgoing: ${portal.outgoing}`);
    console.log(`Communication: ${portal.communication}`);
  });
```

### Software Update

Occasionally, Philips releases new updates for the bridge, lights, and devices.
You can use Huejay to facilitate downloading and installation of updates.  

#### client.softwareUpdate.get - Get software update details

To get software update details, use the `client.softwareUpdate.get` method to
retrieve a `SoftwareUpdate` object. This object provides details about any
pending updates to the bridge or other resources.

```js
client.softwareUpdate.get()
  .then(softwareUpdate => {
    console.log(`State: ${softwareUpdate.state}`);
    console.log(`Release URL: ${softwareUpdate.releaseUrl}`);
    console.log(`Release notes: ${softwareUpdate.releaseNotes}`);
  });
```

The following attributes are available on the `SoftwareUpdate` object:
- `state` - Update state, see below for values
- `checkingEnabled` - `true` if bridge is checking for updates, `false` if not
- `bridge` - `true` if updates are available for the bridge, `false` if not
- `lights` - An array of light ids with available updates
- `sensors` - An array of sensor ids with available updates
- `releaseUrl` - Release URL
- `releaseNotes` - Release notes
- `installNotificationEnabled` - Whether or not the install notification is enabled

The following are possible `state` values:
- `NO_UPDATE` - There are no updates available
- `DOWNLOADING` - Updates are being downloaded
- `READY_TO_INSTALL` - Updates are ready to be installed
- `INSTALLING` - Updates are installing

#### client.softwareUpdate.check - Make bridge check for software updates

You can request the bridge to check for software updates. Call the
`client.softwareUpdate.check` method to have the bridge start checking for
updates. A `huejay.Error` is thrown if the bridge is already checking.

```js
client.softwareUpdate.check()
  .then(() => {
    console.log('Bridge is checking for software updates');
  });
```

#### client.softwareUpdate.install - Start installation of pending updates

If there are any pending software updates, you can use `client.softwareUpdate.install`
to install them. A `huejay.Error` is thrown if there are no updates to install.

```js
client.softwareUpdate.install()
  .then(() => {
    console.log('Installation has begun');
  });
```

#### client.softwareUpdate.disableInstallNotification - Disables install notification

To disable the install notification (useful for mobile apps),
`client.softwareUpdate.disableInstallNotification` will allow you to turn off the
notification. This only works when the notification is enabled.

```js
client.softwareUpdate.disableInstallNotification()
  .then(() => {
    console.log('Install notification is now disabled');
  });
```

### Lights

The Philips Hue API exposes numerous endpoints for managing your lights. Huejay
supports it all, from searching and installing new lights, to changing light
attributes and state.

#### client.lights.scan - Scan for new lights

Hooked up a fresh Philips Hue bridge? Plugged in brand new bulbs or a fixture?
Before you can interact with your new lights, you'll need to add them to your
preferred bridge.

Huejay's `client.lights.scan` will get your bridge to start scanning for new,
unregistered lights. Scans last roughly 30 seconds. New bulbs can then be
retrieved by using `client.lights.getNew`.

```js
client.lights.scan()
  .then(() => {
    console.log('Started new light scan');
  });
```

*Note: Make sure your bulbs are powered on for your bridge to find them.*

#### client.lights.getNew - Get new lights

When bulbs are freshly registered on the bridge, you can retrieve them using
`client.lights.getNew`. This command will ultimately return an array of `Light` objects.

```js
client.lights.getNew()
  .then(lights => {
    console.log('Found new lights:');
    for (let light of lights) {
      console.log(`Light [${light.id}]:`);
      console.log(`  Unique Id: ${light.uniqueId}`);
      console.log(`  Model:     ${light.model.name}`);
      console.log(`  Reachable: ${light.reachable}`);
    }
  });
```

More information on `Light` objects is available in the following commands below.

#### client.lights.getAll - Get all registered lights

Huejay's `client.lights.getAll` will return a list of all registered lights on
the bridge. Like `client.lights.getNew`, the result from the completed `Promise`
will be an array of `Light` objects.

```js
client.lights.getAll()
  .then(lights => {
    for (let light of lights) {
      console.log(`Light [${light.id}]: ${light.name}`);
      console.log(`  Type:             ${light.type}`);
      console.log(`  Unique ID:        ${light.uniqueId}`);
      console.log(`  Manufacturer:     ${light.manufacturer}`);
      console.log(`  Model Id:         ${light.modelId}`);
      console.log('  Model:');
      console.log(`    Id:             ${light.model.id}`);
      console.log(`    Manufacturer:   ${light.model.manufacturer}`);
      console.log(`    Name:           ${light.model.name}`);
      console.log(`    Type:           ${light.model.type}`);
      console.log(`    Color Gamut:    ${light.model.colorGamut}`);
      console.log(`    Friends of Hue: ${light.model.friendsOfHue}`);
      console.log(`  Software Version: ${light.softwareVersion}`);
      console.log('  State:');
      console.log(`    On:         ${light.on}`);
      console.log(`    Reachable:  ${light.reachable}`);
      console.log(`    Brightness: ${light.brightness}`);
      console.log(`    Color mode: ${light.colorMode}`);
      console.log(`    Hue:        ${light.hue}`);
      console.log(`    Saturation: ${light.saturation}`);
      console.log(`    X/Y:        ${light.xy[0]}, ${light.xy[1]}`);
      console.log(`    Color Temp: ${light.colorTemp}`);
      console.log(`    Alert:      ${light.alert}`);
      console.log(`    Effect:     ${light.effect}`);
      console.log();
    }
  });
```

The following `Light` attributes are available:
* `id` - Numerical id of the light as registered on the bridge
* `name` - Configurable name for the light
* `type` - Type of light (e.g. Extended Color Light, Dimmable Light)
* `uniqueId` - Unique Id of the light
* `manufacturer` - Name of the manufacturer
* `modelId` - Model Id of the light, used for determining `LightModel`
* `model` - A `LightModel` object, containing details about the model (not available in other Node.js clients!)
* `softwareVersion` - Software version of the light

The following `Light` state is available:
* `on` - `true` if the light is on, `false` if not
* `reachable` - `true` if the light can be communicated with, `false` if not
* `brightness` - Configurable brightness of the light (value from 0 to 254)
* `colorMode` - Color mode light is respecting (e.g. ct, xy, hs)
* `hue` - Configurable hue of the light (value from 0 to 65535)
* `saturation` - Configurable saturation of the light, compliments `hue` (value from 0 to 254)
* `xy` - Configurable CIE x and y coordinates (value is an array containing x and y values)
* `colorTemp` - Configurable Mired Color temperature of the light (value from 153 to 500)
* `transitionTime` - Configurable temporary value which eases transition of an effect (value in seconds, 0 for instant, 5 for five seconds)
* `alert` - Configurable alert effect (e.g. none, select, lselect)
* `effect` - Configurable effect (e.g. none, colorloop)

Huejay is the only Node.js client that maintains a list of Philips Hue supported
models. The `Light` `model` attribute returns a `LightModel` object which contains
additional details about the model:
* `id` - Model Id, typically the same value as `Light` `modelId`
* `manufacturer` - Manufacturer, typically the same value as `Light` `manufacturer`
* `name` - Name of the model / product (e.g. Hue Spot GU10)
* `type` - Type of light, typically the same value as `Light` `type`
* `colorGamut` - The supported color gamut of the light
* `friendsOfHue` - `true` if Friends of Hue, `false` if not

#### client.lights.getById - Get light by id

If only a single light is needed, `client.lights.getById` can be used to fetch
a light by its bridge assigned id. A `Light` object is returned if the light is
found, else a `huejay.Error` is thrown.

```js
client.lights.getById(1)
  .then(light => {
    console.log('Found light:');
    console.log(`  Light [${light.id}]: ${light.name}`);
  })
  .catch(error => {
    console.log('Could not find light');
    console.log(error.stack);
  });
```

#### client.lights.save - Save a light's attributes and state

After retrieving a `Light` object through previous commands, you can configure
the light and save its attributes and state. This allows you to change a
light's name, color, effect, and so on.

Huejay is smart and keeps track of changed attributes and state. The client
will only send updated values to the Philips Hue bridge, as sending all
configurable attributes and state can affect bridge and light performance.

To save a light, pass a `Light` object to `client.lights.save`. The light is
returned after saving for convenient chaining.

```js
client.lights.getById(3)
  .then(light => {
    light.name = 'New light name';

    light.brightness = 254;
    light.hue        = 32554;
    light.saturation = 254;

    return client.lights.save(light);
  })
  .then(light => {
    console.log(`Updated light [${light.id}]`);
  })
  .catch(error => {
    console.log('Something went wrong');
    console.log(error.stack);
  });
```

The following `Light` object attributes and state are configurable:
* `name`
* `brightness`
* `hue`
* `saturation`
* `xy`
* `colorTemp`
* `transitionTime`
* `alert`
* `effect`

*Note: See further above for details on `Light` attributes and state*

#### client.lights.delete - Delete a light

Remove a light from the bridge with `client.lights.delete`. This will accept
either an id or a `Light` object.

```js
client.lights.delete(4)
  .then(() => {
    console.log('Light was deleted');
  })
  .catch(error => {
    console.log('Light may have been removed already, or does not exist');
    console.log(error.stack);
  });
```

### Groups

#### client.groups.getAll - Get all groups

#### client.groups.getById - Get group by id

#### client.groups.create - Create a group

#### client.groups.save - Save a group's attributes and state

#### client.groups.delete - Delete a group

### Schedules

The Huejay API for managing schedules is not yet finalized.

You can get a sneak peek of schedule management through [examples](examples/schedules).

Expect finalization of the API in release v0.15.0.

### Scenes

The Huejay API for managing scenes is not yet finalized.

You can get a sneak peek of scene management through [examples](examples/scenes).

Expect finalization of the API in release v0.16.0.

### Sensors

The Huejay API for managing sensors is not yet finalized.

You can get a sneak peek of sensor management through [examples](examples/sensors).

Expect finalization of the API in release v0.17.0.

### Rules

The Huejay API for managing rules is not yet finalized.

You can get a sneak peek of rule management through [examples](examples/rules).

Expect finalization of the API in release v0.18.0.

### Time Zones

The Philips Hue bridge supports configuring a local time zone. This is useful
for scheduling functions. Numerous time zones are registered on the bridge for
retrieval.

#### client.timeZones.getAll - Get all time zones

You can retrieve a list of supported time zones by calling
`client.timeZones.getAll`. This will return an array of string values.

```js
client.timeZones.getAll()
  .then(timeZones => {
    for (let tz of timeZones) {
      console.log(tz);
    }
  });
```

## Examples

Want to see more examples? View them in the [examples](examples) directory included
in this repository.

## Logo

Huejay's initial logo was designed by scorpion6 on Fiverr. Font used is Lato Bold.

## License

This software is licensed under the MIT License. [View the license](LICENSE).

Copyright © 2015 [Michael K. Squires](http://sqmk.com)
